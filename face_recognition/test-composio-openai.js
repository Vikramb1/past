const { Composio } = require('@composio/core');
const OpenAI = require('openai');

async function testComposioWithOpenAI() {
    try {
        // Initialize Composio
        const composio = new Composio({ apiKey: 'ak_v3uGsSWnWBJccABnI_5c' });

        // Initialize OpenAI
        const openai = new OpenAI.OpenAI({
            apiKey: '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'
        });

        const authConfig = "ac_8YWxziF2cyD3";

        console.log('Testing Composio with OpenAI integration...\n');

        // Get Gmail tools
        const tools = await composio.tools.get(authConfig, { tools: ["GMAIL_SEND_EMAIL"] });
        console.log('Tools retrieved:', tools ? tools.length : 0);

        // Create OpenAI chat completion with tools
        console.log('\nAsking OpenAI to send email...');
        const response = await openai.chat.completions.create({
            model: "gpt-4o",
            messages: [
                {
                    role: "user",
                    content: "Send an email to sanjay.amirthraj@gmail.com with subject 'Test from CalHacks' and body 'Hi from CalHacks! This is a test email sent via the Composio workflow integration.'"
                }
            ],
            tools: tools,
            tool_choice: "auto"
        });

        console.log('OpenAI response received');
        console.log('Tool calls:', response.choices[0].message.tool_calls ? response.choices[0].message.tool_calls.length : 0);

        // Handle tool calls if any
        if (response.choices[0].message.tool_calls) {
            console.log('\nExecuting tool calls...');

            // Execute each tool call
            for (const toolCall of response.choices[0].message.tool_calls) {
                console.log(`Executing ${toolCall.function.name}...`);
                const params = JSON.parse(toolCall.function.arguments);
                console.log('Parameters:', params);

                // Try using provider's executeToolCall
                const result = await composio.provider.executeToolCall(
                    toolCall,
                    authConfig
                );

                console.log('\n✅ Email sent successfully!');
                console.log('Result:', result);
            }
        } else {
            console.log('No tool calls generated by OpenAI');
            console.log('Response:', response.choices[0].message.content);
        }

    } catch (error) {
        console.error('❌ Error:', error.message);
        if (error.response) {
            console.log('Response status:', error.response.status);
            console.log('Response data:', error.response.data);
        }
    }
}

testComposioWithOpenAI();